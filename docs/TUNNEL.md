# Cloudflare Tunnel Setup & Troubleshooting

This guide explains how to use Cloudflare tunnels for public HTTPS access to your local development environment.

## Quick Start

```bash
# Start with tunnel (public HTTPS access)
make dev-tunnel

# Start without tunnel (localhost only)
make dev-local
```

## How It Works

### Architecture

```
Browser (HTTPS)
    ↓
Cloudflare Tunnel → https://random-id.trycloudflare.com
    ↓
Next.js Dev Server (localhost:3000)
    ↓ (proxies /api/* requests)
Backend API (localhost:8000)
```

### Why Use the Next.js Proxy?

**Problem**: Cloudflare's free tunnel service doesn't support second-level subdomains with valid SSL certificates.

- ✅ Works: `*.trycloudflare.com` (covered by wildcard cert)
- ❌ Fails: `api.your-app.trycloudflare.com` (not covered by cert)

**Solution**: Route all requests through the frontend using Next.js rewrites.

```javascript
// next.config.mjs automatically proxies:
/api/* → http://localhost:8000/*
```

This way:
1. Browser makes HTTPS request to `https://random-id.trycloudflare.com/api/fighters/`
2. Next.js rewrites it to `http://localhost:8000/fighters/`
3. No SSL certificate errors!

## Available Commands

### Development Modes

| Command | Use Case | Public Access | SSL/HTTPS |
|---------|----------|---------------|-----------|
| `make dev` | Default (tunnel) | ✅ Yes | ✅ Yes |
| `make dev-tunnel` | Explicit tunnel | ✅ Yes | ✅ Yes |
| `make dev-local` | Localhost only | ❌ No | ❌ No |

### Component Commands

```bash
# Start individual services
make api         # Backend only (with Docker)
make api-dev     # Backend only with PostgreSQL auto-reload
make frontend    # Frontend only

# Stop everything
make stop        # Stops backend, frontend, and tunnels
```

## Environment Configuration

### `make dev-tunnel` creates this `.env.local`:

```bash
# Auto-generated by make dev-tunnel - DO NOT COMMIT
# Using Next.js /api proxy to avoid SSL cert issues

# Client-side API requests go through Next.js proxy
NEXT_PUBLIC_API_BASE_URL=https://random-id.trycloudflare.com/api

# Next.js rewrites /api/* to this backend
NEXT_API_REWRITE_BASE_URL=http://localhost:8000

# Assets also go through Next.js proxy
NEXT_PUBLIC_ASSETS_BASE_URL=https://random-id.trycloudflare.com/api
```

### `make dev-local` creates this `.env.local`:

```bash
# Auto-generated by make dev-local - DO NOT COMMIT

NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
NEXT_PUBLIC_ASSETS_BASE_URL=http://localhost:8000
```

**Important**: `.env.local` is auto-generated and git-ignored. Don't edit it manually!

## Troubleshooting

### Issue: "Network request failed" or SSL errors

**Symptoms**:
```
ERR_SSL_VERSION_OR_CIPHER_MISMATCH
ERR_NAME_NOT_RESOLVED
```

**Cause**: The `.env.local` file has incorrect URL configuration.

**Solution**:
```bash
# Stop everything
make stop

# Restart with tunnel (regenerates correct config)
make dev-tunnel
```

### Issue: Mixed content warnings

**Symptoms**:
```
Mixed Content: The page at 'https://...' was loaded over HTTPS,
but requested an insecure resource 'http://...'
```

**Cause**: Images or assets loading via HTTP on HTTPS page.

**Solution**: Already fixed in `make dev-tunnel`! The `NEXT_PUBLIC_ASSETS_BASE_URL` routes images through the proxy too.

### Issue: Tunnel URL changes every restart

**This is normal!** Cloudflare's free tunnel service generates a new random URL each time.

**For persistent URLs**, use named tunnels:
```bash
# Create named tunnel (one-time setup)
bash scripts/setup_tunnel.sh

# Start with named tunnel
make dev-tunnel-named  # TODO: implement this
```

### Issue: "Failed to get tunnel URL"

**Cause**: Tunnel didn't start or crashed immediately.

**Solutions**:
1. Check if cloudflared is installed: `cloudflared --version`
2. Install if needed: `brew install cloudflared`
3. Check tunnel logs: `tail -f /tmp/tunnel.log`
4. Try restarting: `make stop && make dev-tunnel`

### Issue: Frontend showing old data

**Cause**: Next.js cache or environment not refreshed.

**Solution**:
```bash
# Clean restart
make dev-clean
```

## Named Tunnels (Persistent URLs)

For production-like testing with custom domains like `ufc.wolfgangschoenberger.com`:

### Setup (one-time)

```bash
# 1. Create tunnel and DNS routes
bash scripts/setup_tunnel.sh

# 2. Verify DNS propagation
bash scripts/check_dns_propagation.sh
```

### Usage

```bash
# Start services with named tunnel
make dev-tunnel-named  # TODO: implement this
```

### Architecture with Named Tunnels

```
ufc.wolfgangschoenberger.com (frontend)
    ↓
Next.js proxy (/api)
    ↓
localhost:8000 (backend)
```

**Why no separate API subdomain?**

The SSL certificate only covers single-level subdomains:
- ✅ `ufc.wolfgangschoenberger.com` (works)
- ✅ `*.wolfgangschoenberger.com` (works)
- ❌ `api.ufc.wolfgangschoenberger.com` (doesn't work - second-level)

So we use the same proxy pattern as the quick tunnel!

## Technical Details

### URL Resolution Flow

1. **Browser request**: `https://tunnel-url.com/api/fighters/`
2. **Next.js receives**: `/api/fighters/`
3. **next.config.mjs rewrites**:
   ```javascript
   /api/:path* → http://localhost:8000/:path*
   ```
4. **Backend receives**: `GET /fighters/`
5. **Response flows back** through the tunnel

### Why Not Direct API Access?

You might wonder: "Why not expose the backend directly on port 8000?"

**Problems with direct backend tunnel**:
1. **SSL Certificate**: Would need `api.domain.com` which requires second-level subdomain support
2. **CORS**: More complex CORS configuration needed
3. **Rate Limiting**: Cloudflare better handles rate limits on single endpoint
4. **Caching**: Next.js can cache API responses

**Benefits of proxy approach**:
1. ✅ Single SSL certificate covers everything
2. ✅ Simpler CORS (same origin)
3. ✅ Can add caching/middleware in Next.js
4. ✅ Single tunnel = simpler infrastructure

## Logs

All logs are written to `/tmp/`:

```bash
# View all logs
tail -f /tmp/backend.log /tmp/frontend.log /tmp/tunnel.log

# View individual logs
tail -f /tmp/tunnel.log   # Cloudflare tunnel
tail -f /tmp/backend.log  # FastAPI backend
tail -f /tmp/frontend.log # Next.js frontend
```

## FAQ

**Q: Why does the tunnel URL change every time?**
A: Free tunnels are temporary. Use named tunnels for persistent URLs.

**Q: Can I use the tunnel from my phone?**
A: Yes! The tunnel URL is publicly accessible from any device.

**Q: Is the tunnel secure?**
A: Yes, it uses HTTPS. But don't expose sensitive data - it's meant for development.

**Q: Why is my tunnel slow?**
A: Free tunnels route through Cloudflare's global network. Named tunnels may be faster.

**Q: Can I customize the tunnel URL?**
A: Only with named tunnels and a custom domain (see Named Tunnels section).

## See Also

- [Cloudflare Tunnel Docs](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)
- [Next.js Rewrites](https://nextjs.org/docs/api-reference/next.config.js/rewrites)
- [CLAUDE.md](../CLAUDE.md) - Claude Code development guide
