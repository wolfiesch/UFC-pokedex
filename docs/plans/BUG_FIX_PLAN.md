# UFC Pokedex - Bug Fix Plan

**Plan Created:** 2025-11-07
**Related:** `../reports/BUG_REPORT.md`
**Priority:** CRITICAL - Blocks all development

---

## Overview

This plan addresses the critical API base URL configuration issue that prevents local development. The fix ensures that `make dev-local` properly configures the frontend to use localhost URLs.

---

## Bug #1: Frontend API Base URL Configuration

**Severity:** ðŸ”´ CRITICAL
**Priority:** P0 (Fix immediately)
**Estimated Effort:** 15-30 minutes
**Files to Modify:** 2
**Files to Create:** 0

### Problem Statement

When developers run `make dev-local`, the frontend should automatically use `http://localhost:8000` for API calls. However, if `frontend/.env.local` already exists with Cloudflare tunnel URLs (from a previous `make dev` run), the application fails to connect to the local backend.

### Root Cause Analysis

1. **Current Behavior:**
   - `make dev-local` starts backend and frontend
   - Does NOT modify `frontend/.env.local`
   - Frontend reads existing `.env.local` which may have Cloudflare tunnel URLs

2. **Why This Happens:**
   - `make dev` sets Cloudflare tunnel URLs in `.env.local`
   - Developers switch to `make dev-local` for faster iteration
   - `.env.local` retains the tunnel URLs
   - No automatic cleanup or switching mechanism exists

3. **`../ai-assistants/CLAUDE.md` Documentation:**
   - States: "Start backend + frontend with localhost URLs (no tunnels, no env changes)"
   - Reality: Does not modify existing env files

### Solution Design

**Option A: Makefile Auto-Configuration (Recommended)**
- âœ… Automatic - no manual steps
- âœ… Foolproof - always correct
- âœ… Matches `../ai-assistants/CLAUDE.md` description
- âŒ Slightly more complex Makefile logic

**Option B: Better Documentation**
- âœ… Simple - no code changes
- âŒ Manual - requires developer action
- âŒ Easy to forget
- âŒ Doesn't match "no env changes" claim

**Decision:** Implement Option A - Auto-configuration in Makefile

---

## Implementation Plan

### Phase 1: Immediate Fix (Quick & Dirty)

**Goal:** Get developers unblocked immediately

**Action:** Update the `.env.local` file manually

**Steps:**
1. Open `frontend/.env.local`
2. Change line 5 from:
   ```env
   NEXT_PUBLIC_API_BASE_URL=https://ufc.wolfgangschoenberger.com/api
   ```
   To:
   ```env
   NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
   ```
3. Change line 8 from:
   ```env
   NEXT_PUBLIC_ASSETS_BASE_URL=https://ufc.wolfgangschoenberger.com/api
   ```
   To:
   ```env
   NEXT_PUBLIC_ASSETS_BASE_URL=http://localhost:8000
   ```
4. Restart frontend: `cd frontend && pnpm dev`
5. Test: Search should now work

**Verification:**
```bash
# Check that API calls go to localhost
curl http://localhost:3000 # Open in browser
# Search for "mcgregor"
# Check console - should show requests to http://localhost:8000
```

---

### Phase 2: Permanent Fix (Makefile Enhancement)

**Goal:** Make `make dev-local` automatically configure localhost URLs

#### Change 1: Update `Makefile` - `dev-local` target

**File:** `Makefile`
**Location:** Lines ~70-100 (in `dev-local` target)

**Current Code:**
```makefile
dev-local: ensure-docker ## Start backend + frontend with localhost URLs (no tunnels, no env changes)
	@echo ""
	@echo "ðŸ”„ Stopping existing processes..."
	@lsof -ti :3000 | xargs kill -9 2>/dev/null || true
	@lsof -ti :8000 | xargs kill -9 2>/dev/null || true
	# ... rest of target
```

**New Code:**
```makefile
dev-local: ensure-docker ## Start backend + frontend with localhost URLs (no tunnels, no env changes)
	@echo ""
	@echo "ðŸ”„ Stopping existing processes..."
	@lsof -ti :3000 | xargs kill -9 2>/dev/null || true
	@lsof -ti :8000 | xargs kill -9 2>/dev/null || true
	@sleep 1
	@echo ""
	@echo "âš™ï¸  Configuring localhost URLs..."
	@mkdir -p frontend
	@echo "# Auto-generated by 'make dev-local' - DO NOT COMMIT" > frontend/.env.local
	@echo "# For Cloudflare tunnel, use 'make dev' instead" >> frontend/.env.local
	@echo "" >> frontend/.env.local
	@echo "NEXT_PUBLIC_API_BASE_URL=http://localhost:8000" >> frontend/.env.local
	@echo "NEXT_PUBLIC_ASSETS_BASE_URL=http://localhost:8000" >> frontend/.env.local
	@echo "âœ… Configured frontend to use http://localhost:8000"
	# ... rest of target (unchanged)
```

**Rationale:**
- Overwrites `.env.local` on every `make dev-local` run
- Clear comments explain it's auto-generated
- Warns not to commit (in case .gitignore is misconfigured)
- References `make dev` for tunnel mode

#### Change 2: Update `.gitignore` (Verify)

**File:** `frontend/.gitignore` or root `.gitignore`
**Action:** Ensure `.env.local` is gitignored

**Check if line exists:**
```bash
grep -r "\.env\.local" .gitignore frontend/.gitignore 2>/dev/null
```

**Add if missing:**
```gitignore
# Local environment files
.env.local
.env*.local
```

#### Change 3: Update `../ai-assistants/CLAUDE.md` Documentation

**File:** `../ai-assistants/CLAUDE.md`
**Location:** Line ~20-25 (under "Running Services")

**Add clarification:**
```markdown
### Running Services
```bash
make dev-local      # Start backend + frontend with localhost (recommended for local dev)
                    # Automatically configures frontend/.env.local for localhost:8000
                    # Previous tunnel configuration will be overwritten
make dev            # Start backend + frontend + Cloudflare tunnels together
                    # Automatically configures frontend/.env.local for tunnel URLs
make api            # Start FastAPI backend only (port 8000)
make frontend       # Start Next.js frontend only (port 3000)
```

**Important:** When switching between `make dev-local` and `make dev`, the environment files are automatically reconfigured. No manual steps needed.
```

---

## Testing Plan

### Test 1: Fresh Checkout (Clean State)

**Scenario:** New developer clones repo

**Steps:**
1. Clone repo (or use git worktree for isolation)
2. Run `make bootstrap` (install deps)
3. Run `make dev-local`
4. Navigate to `http://localhost:3000`
5. Search for "mcgregor"

**Expected:**
- âœ… Search returns results
- âœ… Console shows requests to `http://localhost:8000`
- âœ… No CORS errors
- âœ… No ERR_FAILED errors

### Test 2: Switching from Tunnel Mode

**Scenario:** Developer was using `make dev`, now wants localhost

**Steps:**
1. Start in tunnel mode: `make dev` (if tunnel configured)
2. Verify `frontend/.env.local` has `ufc.wolfgangschoenberger.com`
3. Stop services: `make stop`
4. Switch to local: `make dev-local`
5. Check `.env.local` was rewritten with localhost URLs
6. Test search functionality

**Expected:**
- âœ… `.env.local` overwritten with localhost URLs
- âœ… Frontend connects to local backend
- âœ… All features work

### Test 3: Repeated Runs

**Scenario:** Run `make dev-local` multiple times

**Steps:**
1. Run `make dev-local`
2. Manually edit `.env.local` to use wrong URL
3. Run `make dev-local` again
4. Verify `.env.local` was fixed

**Expected:**
- âœ… `.env.local` always correct after `make dev-local`
- âœ… No manual intervention needed

### Test 4: Comprehensive Feature Test

**Scenario:** Test all pages after fix

**Steps:**
1. Apply fix
2. Run `make dev-local`
3. Test each page:
   - Home page: âœ… Loads fighters
   - Search: âœ… Returns results
   - Fighter detail: âœ… Shows data
   - Events: âœ… Lists events
   - Favorites: âœ… Can add/remove (if implemented)
4. Check browser console: âœ… No errors

**Expected:**
- âœ… All API calls succeed
- âœ… No network errors
- âœ… All data loads correctly

---

## Rollback Plan

If the Makefile changes cause issues:

1. **Revert Makefile:**
   ```bash
   git checkout Makefile
   ```

2. **Manual fix:**
   ```bash
   cp frontend/.env.example frontend/.env.local
   ```

3. **Restart services:**
   ```bash
   make stop
   make dev-local
   ```

---

## Future Improvements (Optional)

### Enhancement 1: Make `dev` auto-configure tunnel URLs

**Currently:** `make dev` expects manual .env.local configuration

**Improvement:** Have `make dev` auto-write tunnel URLs to `.env.local`, similar to `dev-local` fix

**Benefit:** Consistent behavior between `dev` and `dev-local`

### Enhancement 2: Validation Check

Add a check in `dev-local` target to verify backend is responding:

```makefile
@echo "ðŸ” Verifying backend..."
@for i in 1 2 3 4 5; do \
  if curl -sf http://localhost:8000/health > /dev/null 2>&1; then \
    echo "âœ… Backend ready at http://localhost:8000"; \
    break; \
  fi; \
  sleep 1; \
done
```

### Enhancement 3: Environment Switcher Script

Create a `scripts/switch-env.sh` script:

```bash
#!/bin/bash
case "$1" in
  local)
    echo "Switching to localhost configuration..."
    # Set localhost URLs
    ;;
  tunnel)
    echo "Switching to tunnel configuration..."
    # Set tunnel URLs
    ;;
  *)
    echo "Usage: $0 {local|tunnel}"
    exit 1
    ;;
esac
```

---

## Success Criteria

The fix is considered successful when:

- âœ… Running `make dev-local` from any state results in working localhost setup
- âœ… Search functionality returns results
- âœ… Fighter detail pages load data
- âœ… Events page shows events
- âœ… No CORS errors in console
- âœ… No `ERR_FAILED` network errors
- âœ… Documentation matches actual behavior
- âœ… All automated tests pass (if they exist)

---

## Implementation Checklist

### Immediate Fix (Do First)
- [ ] Manually update `frontend/.env.local` with localhost URLs
- [ ] Restart frontend server
- [ ] Test search functionality
- [ ] Commit message: "fix: correct frontend API base URL for local development"

### Permanent Fix (Do Next)
- [ ] Update Makefile `dev-local` target to auto-configure .env.local
- [ ] Verify `.env.local` is in `.gitignore`
- [ ] Update `../ai-assistants/CLAUDE.md` with clarified instructions
- [ ] Test fresh checkout scenario
- [ ] Test switching from tunnel mode
- [ ] Test all pages (home, search, detail, events)
- [ ] Commit message: "fix: auto-configure localhost URLs in make dev-local"

### Documentation & Communication
- [ ] Update any developer onboarding docs
- [ ] Notify team of changes (if applicable)
- [ ] Update any CI/CD documentation

---

## Timeline

- **Immediate Fix:** 5 minutes
- **Permanent Fix:** 15-20 minutes
- **Testing:** 10 minutes
- **Documentation:** 5 minutes
- **Total:** ~30-40 minutes

---

**Plan Author:** Claude Code (AI Assistant)
**Plan Date:** 2025-11-07 04:58 PST
**Status:** Ready for implementation
