# Cloudflare Tunnel Setup Guide

This guide will help you set up Cloudflare Tunnel for public access to your UFC Pokedex application.

## Overview

Your application will be accessible at:
- **Frontend**: https://ufc.wolfgangschoenberger.com
- **Backend API**: https://api.ufc.wolfgangschoenberger.com

## Quick Start

### 1. Run One-Time Setup

```bash
bash scripts/setup_tunnel.sh
```

This script will:
1. ✅ Authenticate with Cloudflare (opens browser)
2. ✅ Create a tunnel named `ufc-pokedex`
3. ✅ Set up DNS routes for your subdomains
4. ✅ Generate config file at `~/.cloudflared/config.yml`

**Note**: You only need to run this once!

### 2. Start Development Environment

```bash
make dev
```

This will automatically:
- Start the backend (FastAPI on port 8000)
- Start the frontend (Next.js on port 3000)
- Start Cloudflare Tunnel
- Configure CORS and API URLs automatically

### 3. Access Your Application

**Local URLs** (always available):
- Frontend: http://localhost:3000
- Backend: http://localhost:8000

**Public URLs** (via Cloudflare Tunnel):
- Frontend: https://ufc.wolfgangschoenberger.com
- Backend: https://api.ufc.wolfgangschoenberger.com

## Manual Tunnel Commands

If you need to manage the tunnel manually:

```bash
# Start tunnel manually
cloudflared tunnel run ufc-pokedex

# Stop all tunnels
make tunnel-stop
# or
pkill cloudflared

# List all tunnels
cloudflared tunnel list

# Get tunnel details
cloudflared tunnel info ufc-pokedex

# View tunnel logs
tail -f /tmp/tunnel.log
```

## DNS Propagation Check

After running the one-time setup, DNS records need to propagate. Use this script to check the status:

```bash
bash scripts/check_dns_propagation.sh
```

This will check:
- ✅ Cloudflare DNS resolution
- ✅ Local DNS resolution
- ✅ nslookup functionality
- ✅ HTTPS connectivity

**If DNS hasn't propagated yet**, the script will show you 4 options to fix it immediately.

## Troubleshooting

### DNS Not Resolving (ERR_NAME_NOT_RESOLVED)

**Quick Fix** - Add to hosts file (immediate):
```bash
echo "104.21.14.155 api.ufc.wolfgangschoenberger.com" | sudo tee -a /etc/hosts
```

**Or wait** - DNS typically propagates in 5-30 minutes. Check status with:
```bash
bash scripts/check_dns_propagation.sh
```

### Tunnel not starting

1. Check if setup was completed:
   ```bash
   ls -la ~/.cloudflared/config.yml
   ```

2. Re-run setup:
   ```bash
   bash scripts/setup_tunnel.sh
   ```

3. Check tunnel logs:
   ```bash
   tail -f /tmp/tunnel.log
   ```

### DNS not resolving

1. Verify DNS records:
   ```bash
   nslookup ufc.wolfgangschoenberger.com
   nslookup api.ufc.wolfgangschoenberger.com
   ```

2. Check Cloudflare DNS routes:
   ```bash
   cloudflared tunnel route dns list
   ```

3. Re-create DNS routes if missing:
   ```bash
   cloudflared tunnel route dns ufc-pokedex ufc.wolfgangschoenberger.com
   cloudflared tunnel route dns ufc-pokedex api.ufc.wolfgangschoenberger.com
   ```

### CORS errors

The `make dev` command automatically configures CORS. If you see CORS errors:

1. Check `.env` file has:
   ```
   CORS_ALLOW_ORIGINS=https://ufc.wolfgangschoenberger.com
   ```

2. Check `frontend/.env.local` has:
   ```
   NEXT_PUBLIC_API_BASE_URL=https://api.ufc.wolfgangschoenberger.com
   ```

3. Restart services:
   ```bash
   make tunnel-stop
   make dev
   ```

### Backend not accessible

1. Verify backend is running:
   ```bash
   curl http://localhost:8000/health
   ```

2. Test tunnel connectivity:
   ```bash
   curl https://api.ufc.wolfgangschoenberger.com/health
   ```

3. Check backend logs:
   ```bash
   tail -f /tmp/backend.log
   ```

## Configuration Files

### Generated by Setup Script
- `~/.cloudflared/config.yml` - Tunnel configuration
- `~/.cloudflared/<tunnel-id>.json` - Tunnel credentials

### Project Files
- `scripts/setup_tunnel.sh` - One-time setup script
- `scripts/start_tunnels.sh` - Tunnel startup script (called by `make dev`)
- `.cloudflared/config.template.yml` - Template for reference

## How It Works

1. **Setup Phase** (one-time):
   - `scripts/setup_tunnel.sh` creates a named tunnel and DNS routes
   - Cloudflare creates CNAME records pointing to your tunnel

2. **Runtime Phase** (every time you run `make dev`):
   - `scripts/start_tunnels.sh` starts the tunnel daemon
   - Cloudflare routes public traffic to your local ports
   - Environment variables are auto-configured for CORS and API URLs

3. **Traffic Flow**:
   ```
   Internet Request (HTTPS)
       ↓
   Cloudflare Global Network
       ↓
   Cloudflare Tunnel (encrypted)
       ↓
   Your Local Machine
       ├─ Port 3000 (Frontend)
       └─ Port 8000 (Backend)
   ```

## Security Notes

- Tunnel credentials are stored in `~/.cloudflared/` (keep this secure!)
- Only your authenticated Cloudflare account can access the tunnel
- All traffic is encrypted end-to-end via Cloudflare
- No need to open firewall ports or configure NAT
- You can revoke tunnel access anytime from Cloudflare dashboard

## Need Help?

- Cloudflare Tunnel Docs: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/
- Check logs: `/tmp/tunnel.log`, `/tmp/backend.log`, `/tmp/frontend.log`
- See `CLAUDE.md` for more development info
